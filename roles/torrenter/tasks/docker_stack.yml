---
- name: "Ensure target directory exists for transmission stack"
  ansible.builtin.file:
    path: "/home/{{ansible_user}}/ansible_docker/transmission"
    state: directory
    owner: "{{ansible_user}}"
    group: "{{ansible_user}}"
    mode: '0755'

- name: "Copy static docker files"
  ansible.builtin.copy:
    src: "files/{{ item }}/"
    dest: "/home/{{ ansible_user }}/ansible_docker/transmission/{{ item }}/"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'
    remote_src: false
  loop:
    - backup
    - gluetun
    - mam-updater
    - ptp-archiver
    - transmission-healthcheck
  register: docker_files_copy

- name: "Set fact if static docker files changed"
  ansible.builtin.set_fact:
    static_docker_files_changed: "{{ docker_files_copy.results | selectattr('changed', 'equalto', true) | length > 0 }}"

- name: "Template compose.yaml from j2"
  ansible.builtin.template:
    src: "compose.yaml.j2"
    dest: "/home/{{ansible_user}}/ansible_docker/transmission/compose.yaml"
    owner: "{{ansible_user}}"
    group: "{{ansible_user}}"
    mode: '0644'
  register: docker_compose_template

- name: "Create .env file from template"
  ansible.builtin.template:
    src: "env.j2"
    dest: "/home/{{ansible_user}}/ansible_docker/transmission/.env"
    owner: "{{ansible_user}}"
    group: "{{ansible_user}}"
    mode: '0600' # Secrets file should not be world-readable
  no_log: true
  register: docker_env_template

- name: "Deploy the transmission docker stack"
  community.docker.docker_compose_v2:
    project_src: "/home/{{ansible_user}}/ansible_docker/transmission"
    state: present
    build: "{{ 'always' if (static_docker_files_changed or docker_compose_template.changed or docker_env_template.changed) else 'policy' }}" # Conditionally build images
    # No rebuild: true is needed here, build: always handles it.
