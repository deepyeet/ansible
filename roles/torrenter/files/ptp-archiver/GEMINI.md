# Project Overview

This project consists of a Dockerized service designed to automate torrent archiving from the PassThePopcorn (PTP) tracker. The core component is a Python script (`archiver.py`) that communicates with the PTP API to fill pre-defined "containers" with torrents.

The entire process is orchestrated by a shell script (`start.sh`) that runs inside a `python:3.11-slim` Docker container.

## Key Components & Architecture

1.  **`Dockerfile`**: Defines the runtime environment. It builds upon a slim Python 3.11 image, sets the working directory to `/app`, and installs necessary dependencies (`curl`, `gawk`, `jq`, `requests`). It sets up a non-root user `ptp` for security and copies the `start.sh` script into the image.

2.  **`start.sh`**: The main entrypoint and orchestrator, located at `/app/start.sh`. It runs in an infinite loop every 6 hours and performs the following actions:
    *   **Resilient Download**: Ensures `archiver.py` exists in `/app`, downloading it from PTP if it's missing or empty.
    *   **Dynamic Configuration**: Generates the `/app/config.ptp` file using environment variables.
    *   **Healthchecks**: Integrates with Healthchecks.io.
    *   **Individual Fetching**: Dynamically discovers container names and fetches torrents for each one.
    *   **Status Reporting**: Generates a concise summary of the outcome for each container and sends it as a diagnostic message to Healthchecks.io.

3.  **`archiver.py`**: The client utility provided by PTP, which will be downloaded into the `/app` directory. It handles all API communication.

4.  **`config.ptp`**: The JSON configuration file for `archiver.py`, dynamically generated by `start.sh` in the `/app` directory on every run.

## Building and Running

This project is intended to be run as a Docker container, typically as part of a larger Docker Compose stack.

### Primary Deployment (Docker Compose)

This service is a component of a larger stack defined in a `compose.yaml` file in a parent directory. The primary way to run this service is by using Docker Compose from that directory.

```bash
# From the parent directory
docker-compose up -d
```

The `compose.yaml` file manages the build process, environment variables, and the `/watch` volume mount for this service.

### Standalone Testing

For development or testing purposes, you can build and run this service independently.

1.  **Build the Image**:
    ```bash
    docker build -t ptp-archiver .
    ```

2.  **Run the Container**:
    You must provide the `PTP_USER` and `PTP_KEY` environment variables.
    ```bash
    docker run -d \
      --name ptp-archiver \
      -e PTP_USER="YOUR_PTP_USER_ID" \
      -e PTP_KEY="YOUR_PTP_API_KEY" \
      -v /path/to/your/watch/dir:/watch \
      ptp-archiver
    ```

## Development Conventions

*   **Immutability of `archiver.py`**: The `archiver.py` script is automatically downloaded and should not be modified directly.
*   **Application Directory**: The service follows the convention of using `/app` as its working directory. All internal files are contained within this directory.
*   **Health Monitoring**: The script is designed for robust, unattended operation via Healthchecks.io integration.
*   **Error Handling**: The `start.sh` script is responsible for interpreting the output of `archiver.py`.
*   **Dependency Management**: The `Dockerfile` handles all system and Python dependencies.
